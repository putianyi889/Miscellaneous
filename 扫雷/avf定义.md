# AVF 文件定义
来源于[avf解析器](https://github.com/Minesweeper-World/minesweeper-rawvf)以及个人的观察，未必准确

- 1字节：大版本号
- 4字节：不知道是干啥的，记为`prefix`
- 1字节：模式。3=初级，4=中级，5=高级，6=自定义。对于自定义，用额外的字节存储参数
  - 1字节：宽w
  - 1字节：高h
  - 2字节：雷数m，大端
- 2m字节：雷的位置。每雷2字节，分别表示行列下标，从1开始
- 一串不知道干什么的乱码，记为`prestamp`
- 由`[]`标志的字符串录像信息，每项之间由`|`隔开
  - [冗余]模式
    - `0`表示初级，`1`表示中级，`2`表示高级，`3`表示自定义
  - [冗余]如果是自定义，加一项形如`WxxHxxMxxx`的自定义参数
  - 起始时间戳
  - 终止时间戳
  - `HS`表示是纪录局。这一项可能没有
  - [冗余]形如`B?T?`，记录3BV和时间（+1s）。时间格式和系统语言相关，某些语言的小数点是逗号
- 一串不知道干什么的乱码，记为`preevent`
- 鼠标事件列，第一个事件的开头是`\0\1`，每个事件占用8字节
  - 第1字节：操作
  - 2字节：横坐标。第2字节高位，第4字节低位
  - 2字节：纵坐标。第6字节高位，第8字节低位
  - 2字节：`时间+1s`的整数部分。第7字节高位，第3字节低位
  - 第5字节：时间的小数部分
- 一串不知道干什么的乱码。开头几个是0，标志鼠标事件的结束，因为不可能`时间+1s=0`
- 以`cs=`开头的20字节乱码，这一部分和上一部分统一记为`presuffix`
- 文件结尾的一串字符串录像信息，每项之间由`\r`隔开
  - [冗余]`RealTime: xxxx`。0.47版本该项不存在
  - `Skin: xxxx`。0.47版本该项不存在
  - 录像标识
  - [冗余]软件信息
    - 0.52.3版本是`Minesweeper Arbiter 0.52.3. Copyright \xa9 2005-2006 Dmitriy I. Sukhomlynov`
    - 0.47版本是`Minesweeper Arbiter 0.47. Copyright \xa9 2005-2006 Dmitriy I. Sukhomlynov`

# AVF 压缩格式 V1.0
- 1字节：压缩算法
- 1字节：大版本号
- 4字节：prefix
- 1字节：参数控制
  - 2位：模式。00表示初级，01表示中级，10表示高级，11表示自定义
  - 1位：是否为纪录
  - 1位：小数点是`.`还是`,`
- 对于0.52.3版本，额外1字节存储皮肤
  - `\1` 代表`3.1`
- 对于自定义，用额外的字节存储参数
  - 1字节：宽w
  - 1字节：高h
- 时间戳
  - 9字节：从2000年1月1日0时整到录像开始的时间，单位0.01s（可以用300年左右）
  - 3字节：录像用时，单位0.01s（可以持续不到两天）
- 标识，以`\r`结尾
- 乱码
  - 2字节：`prestamp`长度
  - `prestamp`
  - 2字节：`preevent`长度
  - `preevent`
  - 2字节：`presuffix`在`cs=`之前的长度
  - `presuffix`
- 雷的排布
  - 01串表示，长度可以通过长宽推出来。通过排布可以推出雷数和3BV。
- 事件列。不同阿比特版本的压缩策略不同。
  - 3字节：事件数量
  - 时间戳序列
  - 坐标序列
  - 按键序列
 
## 时间戳序列压缩

### 0.52.3

#### 准备工作
1. 对时间戳进行差分编码，得到相邻时间戳的时间差。第一个时间戳一定是0，可不储存。
2. 先用比特串进行稠密存储，0表示0，1表示1或其他。提取出差分大于1的索引和差值，称为稀疏部分。
3. 对稀疏部分的索引再进行一次差分编码，得到索引差分（包含第一个索引）。索引差分至少为1。
4. 稀疏部分的差值至少为2，将其再减去2。
5. 找到稀疏部分差值的最大值和索引差分的最大值，确定它们所需位数。
6. 用相应的位数对索引差分和稀疏部分差值交错进行顺序存储。因为索引差分至少为1，用0标记结束。

#### 存储格式
- 稠密部分。位数=事件数量
- 1字节：索引差分所需位数
- 1字节：稀疏部分差值所需位数
- 稀疏部分

## 坐标序列压缩

### 0.52.3

#### 准备工作
1. 对横纵坐标分别进行差分编码，得到相邻事件的坐标差（不包含初值）。
2. 稠密存储，0表示0或其他，10表示-1，11表示1。提取出绝对值大于1的索引和值，称为稀疏部分。
3. 分别提取出稀疏部分的符号位和绝对值，将绝对值减去2。
4. 对稀疏部分的索引进行一次差分编码，得到索引差分（包含第一个索引）。索引差分至少为1。
5. 找到绝对值的最大值和索引差分的最大值，确定它们所需位数。
6. 用相应的位数对索引差分、符号位、绝对值交错进行顺序存储。因为索引差分至少为1，用0标记结束。

#### 存储格式
- 2字节：初始横坐标
- 2字节：初始纵坐标
- 稠密部分。`位数≈1.5*事件数量`
- 1字节：索引差分所需位数
- 1字节：绝对值所需位数
- 稀疏部分

## 按键序列压缩

### 0.52.3

#### 准备工作
1. 分别找出左键操作和右键操作的事件索引，分别存为两个数组。左键一定是lc和lr交错，右键一定是rc和rr交错，因此只存储索引。既不是左键又不是右键的索引就是mv
2. 对两个索引数组分别进行差分编码，得到索引差分（包含第一个索引）
3. 分别找到两个索引差分的最大值，确定它们所需位数。
4. 用相应的位数对两个索引差分分别进行顺序存储。因为索引差分至少为1，用0标记结束。

#### 存储格式
- 1字节：左键所需位数
- 左键索引差分
- 1字节：右键所需位数
- 右键索引差分
